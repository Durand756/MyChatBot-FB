<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Automation Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .login-form, .register-form {
            max-width: 400px;
            margin: 100px auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], input[type="email"], input[type="password"], 
        input[type="number"], textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .page-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .page-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .page-item small {
            color: #666;
        }

        .response-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .response-content {
            flex: 1;
        }

        .keyword {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .priority {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .message-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-type {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .message-type.predefined {
            background: #e7f3ff;
            color: #1976d2;
        }

        .message-type.ai {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Formulaire de connexion -->
        <div id="loginForm" class="login-form card">
            <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Connexion</h2>
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Mot de passe</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 15px;">Se connecter</button>
                <button type="button" class="btn-secondary btn" style="width: 100%;" onclick="showRegister()">Cr√©er un compte</button>
            </form>
        </div>

        <!-- Formulaire d'inscription -->
        <div id="registerForm" class="register-form card hidden">
            <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Inscription</h2>
            <form id="registerFormElement">
                <div class="form-group">
                    <label for="registerName">Nom complet</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Mot de passe</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="btn" style="width: 100%; margin-bottom: 15px;">S'inscrire</button>
                <button type="button" class="btn-secondary btn" style="width: 100%;" onclick="showLogin()">D√©j√† un compte ?</button>
            </form>
        </div>

        <!-- Dashboard principal -->
        <div id="dashboard" class="dashboard">
            <!-- Header -->
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="color: #333;">ü§ñ Facebook Automation Platform</h1>
                        <p style="color: #666; margin-top: 5px;">Bienvenue <span id="userName"></span></p>
                    </div>
                    <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
                </div>
            </div>

            <!-- Onglets de navigation -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('pages')">üìÑ Mes Pages</button>
                <button class="tab" onclick="showTab('responses')">üí¨ R√©ponses</button>
                <button class="tab" onclick="showTab('ai-config')">ü§ñ Configuration IA</button>
                <button class="tab" onclick="showTab('history')">üìä Historique</button>
            </div>

            <!-- Contenu des onglets -->
            <!-- Onglet Pages -->
            <div id="pages-tab" class="tab-content active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üîó Pages Facebook connect√©es</h3>
                        <button class="btn" onclick="showConnectPageModal()">+ Connecter une page</button>
                    </div>
                    <div id="pagesList">
                        <p style="text-align: center; color: #666;">Aucune page connect√©e</p>
                    </div>
                </div>
            </div>

            <!-- Onglet R√©ponses -->
            <div id="responses-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üí¨ R√©ponses pr√©d√©finies</h3>
                        <div>
                            <select id="responsePageSelect" style="margin-right: 10px;">
                                <option value="">S√©lectionner une page</option>
                            </select>
                            <button class="btn" onclick="showAddResponseModal()">+ Ajouter</button>
                        </div>
                    </div>
                    <div id="responsesList">
                        <p style="text-align: center; color: #666;">S√©lectionnez une page pour voir les r√©ponses</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Configuration IA -->
            <div id="ai-config-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ü§ñ Configuration de l'IA</h3>
                        <select id="aiPageSelect">
                            <option value="">S√©lectionner une page</option>
                        </select>
                    </div>
                    <form id="aiConfigForm">
                        <div class="grid">
                            <div class="form-group">
                                <label for="aiProvider">Fournisseur IA</label>
                                <select id="aiProvider" required>
                                    <option value="">Choisir...</option>
                                    <option value="OpenAI">OpenAI (GPT)</option>
                                    <option value="Mistral">Mistral AI</option>
                                    <option value="Claude">Anthropic Claude</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="aiModel">Mod√®le</label>
                                <select id="aiModel" required>
                                    <option value="">Choisir d'abord le fournisseur</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="aiApiKey">Cl√© API</label>
                            <input type="password" id="aiApiKey" placeholder="Votre cl√© API" required>
                        </div>
                        <div class="form-group">
                            <label for="aiTemperature">Temp√©rature (0-1)</label>
                            <input type="number" id="aiTemperature" min="0" max="1" step="0.1" value="0.7">
                        </div>
                        <div class="form-group">
                            <label for="aiInstructions">Instructions syst√®me</label>
                            <textarea id="aiInstructions" rows="4" placeholder="Ex: R√©ponds de mani√®re amicale et professionnelle. Utilise des emojis mod√©r√©ment..."></textarea>
                        </div>
                        <button type="submit" class="btn">üíæ Sauvegarder</button>
                    </form>
                </div>
            </div>

            <!-- Onglet Historique -->
            <div id="history-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üìä Historique des conversations</h3>
                        <select id="historyPageSelect">
                            <option value="">S√©lectionner une page</option>
                        </select>
                    </div>
                    <div id="historyList">
                        <p style="text-align: center; color: #666;">S√©lectionnez une page pour voir l'historique</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de connexion de page -->
        <div id="connectPageModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('connectPageModal')">&times;</span>
                <h3 style="margin-bottom: 20px;">üîó Connecter une page Facebook</h3>
                <form id="connectPageForm">
                    <div class="form-group">
                        <label for="pageId">ID de la page Facebook</label>
                        <input type="text" id="pageId" required placeholder="Ex: 123456789012345">
                    </div>
                    <div class="form-group">
                        <label for="pageName">Nom de la page</label>
                        <input type="text" id="pageName" required placeholder="Ex: Ma Super Page">
                    </div>
                    <div class="form-group">
                        <label for="accessToken">Token d'acc√®s √† la page</label>
                        <input type="text" id="accessToken" required placeholder="Token long-lived de votre page">
                    </div>
                    <div class="form-group">
                        <label for="appId">Facebook App ID</label>
                        <input type="text" id="appId" required placeholder="Votre App ID Facebook">
                    </div>
                    <div class="form-group">
                        <label for="appSecret">Facebook App Secret</label>
                        <input type="password" id="appSecret" required placeholder="Votre App Secret">
                    </div>
                    <div class="form-group">
                        <label for="webhookToken">Token de v√©rification Webhook</label>
                        <input type="text" id="webhookToken" required placeholder="Token pour v√©rifier le webhook">
                    </div>
                    <button type="submit" class="btn">üîó Connecter</button>
                </form>
            </div>
        </div>

        <!-- Modal d'ajout de r√©ponse -->
        <div id="addResponseModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('addResponseModal')">&times;</span>
                <h3 style="margin-bottom: 20px;">üí¨ Ajouter une r√©ponse</h3>
                <form id="addResponseForm">
                    <div class="form-group">
                        <label for="responseKeyword">Mot-cl√© d√©clencheur</label>
                        <input type="text" id="responseKeyword" required placeholder="Ex: bonjour, prix, contact">
                    </div>
                    <div class="form-group">
                        <label for="responseText">R√©ponse</label>
                        <textarea id="responseText" rows="3" required placeholder="La r√©ponse √† envoyer..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="responsePriority">Priorit√© (1-10)</label>
                        <input type="number" id="responsePriority" min="1" max="10" value="1">
                    </div>
                    <button type="submit" class="btn">üíæ Ajouter</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let token = localStorage.getItem('token');
        let currentPageId = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (token) {
                showDashboard();
                loadPages();
            } else {
                showLogin();
            }

            // Event listeners
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('registerFormElement').addEventListener('submit', handleRegister);
            document.getElementById('connectPageForm').addEventListener('submit', handleConnectPage);
            document.getElementById('addResponseForm').addEventListener('submit', handleAddResponse);
            document.getElementById('aiConfigForm').addEventListener('submit', handleAIConfig);
            
            // Listeners pour les selects
            document.getElementById('responsePageSelect').addEventListener('change', handleResponsePageChange);
            document.getElementById('aiPageSelect').addEventListener('change', handleAIPageChange);
            document.getElementById('historyPageSelect').addEventListener('change', handleHistoryPageChange);
            document.getElementById('aiProvider').addEventListener('change', handleProviderChange);
        });

        // Fonctions d'authentification
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('active');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('active');
        }

        function showDashboard() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    token = data.token;
                    currentUser = data.user;
                    localStorage.setItem('token', token);
                    document.getElementById('userName').textContent = currentUser.name;
                    showDashboard();
                    loadPages();
                    showAlert('Connexion r√©ussie !', 'success');
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Erreur de connexion', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Compte cr√©√© avec succ√®s !', 'success');
                    showLogin();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la cr√©ation du compte', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            showLogin();
        }

        // Fonctions de gestion des onglets
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Fonctions de gestion des pages
        async function loadPages() {
            try {
                const response = await fetch('/api/facebook/pages', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const pages = await response.json();
                displayPages(pages);
                populatePageSelects(pages);
            } catch (error) {
                showAlert('Erreur lors du chargement des pages', 'error');
            }
        }

        function displayPages(pages) {
            const pagesList = document.getElementById('pagesList');
            
            if (pages.length === 0) {
                pagesList.innerHTML = '<p style="text-align: center; color: #666;">Aucune page connect√©e</p>';
                return;
            }

            pagesList.innerHTML = pages.map(page => `
                <div class="page-item">
                    <div>
                        <h4>${page.page_name}</h4>
                        <small>ID: ${page.page_id} ‚Ä¢ ${page.is_active ? '‚úÖ Active' : '‚ùå Inactive'}</small>
                        <br><small>Connect√©e le ${new Date(page.created_at).toLocaleDateString()}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="managePage('${page.page_id}')">G√©rer</button>
                    </div>
                </div>
            `).join('');
        }

        function populatePageSelects(pages) {
            const selects = ['responsePageSelect', 'aiPageSelect', 'historyPageSelect'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">S√©lectionner une page</option>';
                
                pages.forEach(page => {
                    const option = document.createElement('option');
                    option.value = page.page_id;
                    option.textContent = page.page_name;
                    select.appendChild(option);
                });
            });
        }

        function showConnectPageModal() {
            document.getElementById('connectPageModal').style.display = 'block';
        }

        async function handleConnectPage(e) {
            e.preventDefault();
            
            const formData = {
                pageId: document.getElementById('pageId').value,
                pageName: document.getElementById('pageName').value,
                accessToken: document.getElementById('accessToken').value,
                appId: document.getElementById('appId').value,
                appSecret: document.getElementById('appSecret').value,
                webhookToken: document.getElementById('webhookToken').value
            };

            try {
                const response = await fetch('/api/facebook/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Page connect√©e avec succ√®s !', 'success');
                    closeModal('connectPageModal');
                    loadPages();
                    document.getElementById('connectPageForm').reset();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la connexion de la page', 'error');
            }
        }

        // Fonctions de gestion des r√©ponses
        function handleResponsePageChange() {
            const pageId = document.getElementById('responsePageSelect').value;
            if (pageId) {
                currentPageId = pageId;
                loadResponses(pageId);
            } else {
                document.getElementById('responsesList').innerHTML = '<p style="text-align: center; color: #666;">S√©lectionnez une page pour voir les r√©ponses</p>';
            }
        }

        async function loadResponses(pageId) {
            try {
                const response = await fetch(`/api/responses/${pageId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const responses = await response.json();
                displayResponses(responses);
            } catch (error) {
                showAlert('Erreur lors du chargement des r√©ponses', 'error');
            }
        }

        function displayResponses(responses) {
            const responsesList = document.getElementById('responsesList');
            
            if (responses.length === 0) {
                responsesList.innerHTML = '<p style="text-align: center; color: #666;">Aucune r√©ponse configur√©e</p>';
                return;
            }

            responsesList.innerHTML = responses.map(response => `
                <div class="response-item">
                    <div class="response-content">
                        <div class="keyword">${response.keyword}</div>
                        <div>${response.response}</div>
                        <small style="color: #666;">Cr√©√© le ${new Date(response.created_at).toLocaleDateString()}</small>
                    </div>
                    <div>
                        <span class="priority">Priorit√© ${response.priority}</span>
                    </div>
                </div>
            `).join('');
        }

        function showAddResponseModal() {
            if (!currentPageId) {
                showAlert('Veuillez d\'abord s√©lectionner une page', 'error');
                return;
            }
            document.getElementById('addResponseModal').style.display = 'block';
        }

        async function handleAddResponse(e) {
            e.preventDefault();
            
            const formData = {
                pageId: currentPageId,
                keyword: document.getElementById('responseKeyword').value,
                response: document.getElementById('responseText').value,
                priority: parseInt(document.getElementById('responsePriority').value)
            };

            try {
                const response = await fetch('/api/responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('R√©ponse ajout√©e avec succ√®s !', 'success');
                    closeModal('addResponseModal');
                    loadResponses(currentPageId);
                    document.getElementById('addResponseForm').reset();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de l\'ajout de la r√©ponse', 'error');
            }
        }

        // Fonctions de configuration IA
        function handleAIPageChange() {
            const pageId = document.getElementById('aiPageSelect').value;
            if (pageId) {
                loadAIConfig(pageId);
            }
        }

        async function loadAIConfig(pageId) {
            // Charger la configuration IA existante si elle existe
            // Pour l'instant, on reset le formulaire
            document.getElementById('aiConfigForm').reset();
        }

        function handleProviderChange() {
            const provider = document.getElementById('aiProvider').value;
            const modelSelect = document.getElementById('aiModel');
            
            modelSelect.innerHTML = '<option value="">Choisir un mod√®le</option>';
            
            const models = {
                'OpenAI': ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo'],
                'Mistral': ['mistral-large', 'mistral-medium', 'mistral-small'],
                'Claude': ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku']
            };
            
            if (models[provider]) {
                models[provider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
        }

        async function handleAIConfig(e) {
            e.preventDefault();
            
            const pageId = document.getElementById('aiPageSelect').value;
            if (!pageId) {
                showAlert('Veuillez s√©lectionner une page', 'error');
                return;
            }

            const formData = {
                pageId,
                provider: document.getElementById('aiProvider').value,
                apiKey: document.getElementById('aiApiKey').value,
                model: document.getElementById('aiModel').value,
                temperature: parseFloat(document.getElementById('aiTemperature').value),
                instructions: document.getElementById('aiInstructions').value
            };

            try {
                const response = await fetch('/api/ai-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Configuration IA sauvegard√©e !', 'success');
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de la sauvegarde', 'error');
            }
        }

        // Fonctions d'historique
        function handleHistoryPageChange() {
            const pageId = document.getElementById('historyPageSelect').value;
            if (pageId) {
                loadHistory(pageId);
            } else {
                document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: #666;">S√©lectionnez une page pour voir l\'historique</p>';
            }
        }

        async function loadHistory(pageId) {
            try {
                const response = await fetch(`/api/history/${pageId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const history = await response.json();
                displayHistory(history);
            } catch (error) {
                showAlert('Erreur lors du chargement de l\'historique', 'error');
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666;">Aucun message dans l\'historique</p>';
                return;
            }

            historyList.innerHTML = history.map(item => `
                <div class="message-item">
                    <div class="message-header">
                        <strong>Message re√ßu</strong>
                        <div>
                            <span class="message-type ${item.response_type}">${item.response_type}</span>
                            <small style="margin-left: 10px;">${new Date(item.created_at).toLocaleString()}</small>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;"><strong>üë§:</strong> ${item.message_text}</div>
                    <div><strong>ü§ñ:</strong> ${item.response_text}</div>
                </div>
            `).join('');
        }

        // Fonctions utilitaires
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            document.body.insertBefore(alertDiv, document.body.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Fermer les modals en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
